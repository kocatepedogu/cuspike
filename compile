t_begin=$(date +%s%3N)

# --- Enter compiler directory ---
cd compiler

# Delete generated code files
rm ./generated/config.hpp
rm ./generated/kernel-register/*.cu
rm ./generated/kernel-global/*.cu

# Compile compiler
make clean
make -j$(nproc)

# Compile model
cpp -E ../models/$1 | grep -wv '#' | ./compiler

# Leave compiler directory
cd ..

# --- Enter simulator directory ---
cd simulator

# Delete generated code files
rm -r generated

# Copy newly generated code files
cp -r ../compiler/generated ./

# Compile simulator
make clean
make -j$(nproc)

# Leave simulator directory
cd ..

# --- Run simulator ---
./simulator.exe $2

t_end=$(date +%s%3N)
echo "print(($t_end - $t_begin) / 1000)" | python3 > cuspike-elapsedtime.txt

# --- Plot results ---
python3 plot.py
