#!/bin/sh

## Distrobox Configuration ##

export PATH=$(pwd)/../docker/distrobox:$PATH
DISTROBOX() {
  ENV="--env PATH=/venv/bin:/usr/local/cuda/bin:$PATH"
  distrobox enter cuspike-container --additional-flags "$ENV" -- $*
}


run_simulators() {
  # GeNN
  if [ -f "simulate_genn.py" ]; then
    DISTROBOX python3 simulate_genn.py plot
  fi

  # NEST GPU
  if [ -f "simulate_nestgpu.py" ]; then
    DISTROBOX python3 simulate_nestgpu.py plot
  fi

  # Brian2Cuda
  if [ -f "simulate_brian2cuda.py" ]; then
    DISTROBOX python3 simulate_brian2cuda.py plot
  fi

  # cuSpike
  (cd ../.. && DISTROBOX bash ./compile "$1".csm)

  # Plot bar chart for total elapsed time
  DISTROBOX python3 ../plot.py
}


run_benchmark() {
  cd "$1"

  ## ------------- Delete Cache and Generated Files ------------------ ##

  rm -r __pycache__          # Brian2Cuda and NESTGPU
  rm -r model_CODE           # GeNN
  rm -r output               # Brian2Cuda

  ## ------------- Benchmark including compilation time --------------- ##
  # Without the previously generated files and pycache, all simulators
  # using a coding generation approach (GeNN, Brian2Cuda, cuSpike) must
  # generate and compile CUDA code during this benchmark.

  run_simulators "$1"

  # Save elapsed time chart including compilation time as a separate file
  mv elapsedtime.png elapsedtime-including-compilation.png

  ## ------------- Benchmark excluding compilation time --------------- ##
  # GeNN and Brian2Cuda automatically decide whether a change has been
  # made to the model. If there is no change, they use the already present
  # executables and shared libraries generated in the previous execution.
  # cuSpike does not support such an automatical mechanism as of now.

  run_simulators "$1"

  # Save elapsed time chart excluding compilation time as a separate file
  mv elapsedtime.png elapsedtime-excluding-compilation.png
}

#######################################################################
# Current Based Synapses - Leaky Integrate and Fire (CUBA Model)      #
# 20,000 neurons simulated for a biological time of 100 seconds       #
#######################################################################

run_benchmark 'cuba'

#######################################################################
# Conductance Based Synapses - Hodgkin Huxley (COBAHH Model)          #
# 100,000 neurons simulated for a biological time of 5 seconds        #
#######################################################################

run_benchmark 'cobahh'
